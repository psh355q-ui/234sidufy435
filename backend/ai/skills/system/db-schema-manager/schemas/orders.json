{
  "table_name": "orders",
  "description": "실제 주문 실행 기록 (KIS Broker) - State Machine 통합",
  "primary_key": "id",
  "columns": [
    {
      "name": "id",
      "type": "INTEGER",
      "nullable": false,
      "description": "Primary key (auto-increment)",
      "auto_increment": true
    },
    {
      "name": "ticker",
      "type": "VARCHAR(20)",
      "nullable": false,
      "description": "종목 코드",
      "example": "AAPL"
    },
    {
      "name": "action",
      "type": "VARCHAR(10)",
      "nullable": false,
      "description": "매매 방향 (BUY, SELL)",
      "example": "BUY"
    },
    {
      "name": "quantity",
      "type": "INTEGER",
      "nullable": false,
      "description": "주문 수량",
      "example": 100
    },
    {
      "name": "order_type",
      "type": "VARCHAR(20)",
      "nullable": false,
      "default": "market",
      "description": "주문 유형 (market, limit)",
      "example": "market"
    },
    {
      "name": "limit_price",
      "type": "FLOAT",
      "nullable": true,
      "description": "지정가 (limit order용)",
      "example": 150.0
    },
    {
      "name": "filled_price",
      "type": "FLOAT",
      "nullable": true,
      "description": "체결 가격",
      "example": 149.5
    },
    {
      "name": "filled_quantity",
      "type": "INTEGER",
      "nullable": true,
      "description": "체결된 수량 (부분 체결용)",
      "example": 50
    },
    {
      "name": "status",
      "type": "VARCHAR(20)",
      "nullable": false,
      "default": "idle",
      "description": "주문 상태 (OrderState Enum: idle, signal_received, validating, order_pending, order_sent, partial_filled, fully_filled, cancelled, rejected, failed)",
      "example": "order_sent"
    },
    {
      "name": "order_id",
      "type": "VARCHAR(100)",
      "nullable": true,
      "unique": true,
      "description": "브로커 주문 ID",
      "example": "KIS20260110001"
    },
    {
      "name": "created_at",
      "type": "TIMESTAMP",
      "nullable": false,
      "default": "CURRENT_TIMESTAMP",
      "description": "주문 생성 시각"
    },
    {
      "name": "updated_at",
      "type": "TIMESTAMP",
      "nullable": false,
      "default": "CURRENT_TIMESTAMP",
      "description": "주문 상태 업데이트 시각"
    },
    {
      "name": "filled_at",
      "type": "TIMESTAMP",
      "nullable": true,
      "description": "체결 완료 시각"
    },
    {
      "name": "signal_id",
      "type": "INTEGER",
      "nullable": true,
      "foreign_key": {
        "table": "trading_signals",
        "column": "id"
      },
      "description": "연결된 트레이딩 시그널 ID"
    },
    {
      "name": "error_message",
      "type": "TEXT",
      "nullable": true,
      "description": "주문 실패/거부 사유"
    },
    {
      "name": "order_metadata",
      "type": "JSONB",
      "nullable": true,
      "description": "추가 메타데이터 (signal_data, validation_result, broker_info 등) - 'metadata'는 SQLAlchemy 예약어이므로 'order_metadata' 사용",
      "example": {
        "signal_id": 123,
        "broker": "KIS",
        "validation": {
          "passed": true
        }
      }
    },
    {
      "name": "needs_manual_review",
      "type": "BOOLEAN",
      "nullable": false,
      "default": false,
      "description": "수동 검토 필요 플래그 (Recovery 실패 시)"
    }
  ],
  "indexes": [
    {
      "name": "idx_order_ticker",
      "columns": ["ticker"],
      "unique": false
    },
    {
      "name": "idx_order_status",
      "columns": ["status"],
      "unique": false
    },
    {
      "name": "idx_order_created_at",
      "columns": ["created_at"],
      "unique": false
    },
    {
      "name": "idx_order_order_id",
      "columns": ["order_id"],
      "unique": true
    }
  ],
  "metadata": {
    "phase": "Phase 1-3: State Machine + Recovery + Event Bus",
    "created": "2026-01-10",
    "update_frequency": "Real-time",
    "notes": "State Machine 통합으로 상태 전이 강제. Recovery 로직 지원."
  }
}
