{
  "table_name": "position_ownership",
  "description": "포지션 소유권 추적 - 어떤 전략이 어떤 포지션을 소유하는지 관리하여 전략 간 충돌 방지",
  "primary_key": "id",
  "columns": [
    {
      "name": "id",
      "type": "UUID",
      "nullable": false,
      "description": "소유권 레코드 고유 식별자",
      "default": "gen_random_uuid()"
    },
    {
      "name": "position_id",
      "type": "UUID",
      "nullable": true,
      "description": "포지션 ID (positions 테이블 참조). NULL 허용: positions 테이블 미구현 시 ticker로 식별",
      "foreign_key": {
        "table": "positions",
        "column": "id",
        "on_delete": "CASCADE",
        "on_update": "CASCADE",
        "deferrable": true,
        "notes": "positions 테이블이 존재할 때 활성화. 현재는 ticker 기반으로 운영 가능."
      }
    },
    {
      "name": "strategy_id",
      "type": "UUID",
      "nullable": false,
      "description": "소유 전략 ID",
      "foreign_key": {
        "table": "strategies",
        "column": "id",
        "on_delete": "RESTRICT",
        "on_update": "CASCADE",
        "notes": "RESTRICT: 소유권이 있는 전략은 삭제 불가 (먼저 소유권 해제 필요)"
      }
    },
    {
      "name": "ticker",
      "type": "VARCHAR(10)",
      "nullable": false,
      "description": "종목 코드 (포지션 빠른 조회용 비정규화)",
      "example": "NVDA"
    },
    {
      "name": "ownership_type",
      "type": "VARCHAR(20)",
      "nullable": false,
      "description": "소유권 유형 (primary: 독점 소유, shared: 공유 소유)",
      "example": "primary",
      "constraints": {
        "check": "ownership_type IN ('primary', 'shared')"
      }
    },
    {
      "name": "locked_until",
      "type": "TIMESTAMP WITH TIME ZONE",
      "nullable": true,
      "description": "소유권 잠금 해제 시각. NULL이면 잠금 없음. 시간 경과 시 자동 해제.",
      "example": "2026-04-11T00:00:00Z"
    },
    {
      "name": "reasoning",
      "type": "TEXT",
      "nullable": true,
      "description": "소유권 설정 이유 (AI 설명 가능성)",
      "example": "장기 투자 전략이 3개월 보유 목표로 포지션 확보"
    },
    {
      "name": "created_at",
      "type": "TIMESTAMP WITH TIME ZONE",
      "nullable": false,
      "default": "NOW()",
      "description": "소유권 생성 시각"
    }
  ],
  "indexes": [
    {
      "name": "idx_ownership_position",
      "columns": ["position_id"],
      "unique": false,
      "description": "포지션 ID로 소유권 조회 (positions 테이블 JOIN 시 사용)"
    },
    {
      "name": "idx_ownership_strategy",
      "columns": ["strategy_id"],
      "unique": false,
      "description": "전략별 소유 포지션 목록 조회"
    },
    {
      "name": "idx_ownership_ticker",
      "columns": ["ticker"],
      "unique": false,
      "description": "종목별 소유권 빠른 조회 (충돌 검사 핫 경로)"
    },
    {
      "name": "idx_ownership_ticker_strategy",
      "columns": ["ticker", "strategy_id"],
      "unique": false,
      "description": "종목+전략 복합 조회 최적화"
    },
    {
      "name": "idx_ownership_locked",
      "columns": ["locked_until"],
      "unique": false,
      "partial": "locked_until IS NOT NULL",
      "description": "잠금된 소유권 조회 (배치 잠금 해제 작업용)"
    }
  ],
  "constraints": [
    {
      "name": "chk_ownership_type_valid",
      "type": "CHECK",
      "condition": "ownership_type IN ('primary', 'shared')",
      "description": "유효한 소유권 유형만 허용"
    },
    {
      "name": "uq_ticker_primary_ownership",
      "type": "UNIQUE",
      "columns": ["ticker"],
      "partial": "ownership_type = 'primary'",
      "description": "하나의 종목에 대해 primary 소유권은 하나만 존재 가능",
      "notes": "PostgreSQL partial unique index로 구현"
    }
  ],
  "foreign_keys": [
    {
      "name": "fk_ownership_strategy",
      "columns": ["strategy_id"],
      "references": {
        "table": "strategies",
        "columns": ["id"]
      },
      "on_delete": "RESTRICT",
      "on_update": "CASCADE",
      "description": "전략 삭제 시 소유권 먼저 해제 필요"
    },
    {
      "name": "fk_ownership_position",
      "columns": ["position_id"],
      "references": {
        "table": "positions",
        "columns": ["id"]
      },
      "on_delete": "CASCADE",
      "on_update": "CASCADE",
      "description": "포지션 삭제 시 소유권 자동 삭제",
      "deferred": true,
      "notes": "positions 테이블 구현 시 활성화"
    }
  ],
  "metadata": {
    "phase": "Phase 0: Multi-Strategy Orchestration - T0.1",
    "created": "2026-01-11",
    "update_frequency": "Real-time (주문 실행 시 생성/수정)",
    "estimated_rows": "100-500 (활성 포지션 수에 비례)",
    "query_patterns": [
      "종목별 소유권 조회 (충돌 검사): SELECT * FROM position_ownership WHERE ticker = ?",
      "전략별 포지션 목록: SELECT * FROM position_ownership WHERE strategy_id = ?",
      "잠금 해제 대상: SELECT * FROM position_ownership WHERE locked_until < NOW()"
    ],
    "performance_notes": [
      "ticker 조회가 가장 빈번 (충돌 검사 핫 경로)",
      "idx_ownership_ticker 인덱스로 O(log n) 조회 보장",
      "잠금 해제 배치 작업은 비피크 시간에 실행"
    ]
  },
  "design_decisions": {
    "ticker_denormalization": {
      "reason": "충돌 검사 시 position_id JOIN 없이 바로 ticker로 조회 가능",
      "tradeoff": "데이터 중복, position 테이블과 정합성 유지 필요",
      "mitigation": "position 생성 시 트리거로 동기화 또는 애플리케이션 레벨 관리"
    },
    "position_id_nullable": {
      "reason": "positions 테이블이 아직 구현되지 않은 상태에서도 사용 가능",
      "migration_path": "positions 테이블 구현 후 NOT NULL로 변경"
    },
    "restrict_on_strategy_delete": {
      "reason": "전략 삭제 시 관련 소유권 데이터 명시적 정리 강제",
      "workflow": "1) 전략 비활성화 -> 2) 소유권 해제 -> 3) 전략 삭제"
    },
    "partial_unique_constraint": {
      "reason": "primary 소유권은 배타적, shared는 복수 허용",
      "implementation": "PostgreSQL CREATE UNIQUE INDEX ... WHERE ownership_type = 'primary'"
    }
  }
}
