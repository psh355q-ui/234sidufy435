# Phase 25.1 - 24ì‹œê°„ ìˆ˜ìµë¥  ì¶”ì  ì‹œìŠ¤í…œ ì™„ë£Œ

**ë‚ ì§œ**: 2025-12-23
**Phase**: 25.1 - ì—ì´ì „íŠ¸ ì„±ê³¼ ì¸¡ì • ì‹œìŠ¤í…œ
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ðŸ“‹ ì™„ë£Œëœ ìž‘ì—…

### 1ï¸âƒ£ price_tracking í…Œì´ë¸” ìƒì„±

**í…Œì´ë¸” êµ¬ì¡°**:
```sql
CREATE TABLE price_tracking (
    id SERIAL PRIMARY KEY,
    session_id INTEGER REFERENCES ai_debate_sessions(id),
    ticker VARCHAR(20) NOT NULL,

    -- Initial price (debate time)
    initial_price NUMERIC(10, 2) NOT NULL,
    initial_timestamp TIMESTAMP NOT NULL,

    -- Final price (24h later)
    final_price NUMERIC(10, 2),
    final_timestamp TIMESTAMP,

    -- Return calculation
    price_change NUMERIC(10, 2),
    return_pct NUMERIC(10, 4),

    -- Consensus
    consensus_action VARCHAR(10) NOT NULL,  -- BUY/SELL/HOLD
    consensus_confidence NUMERIC(5, 4) NOT NULL,

    -- Performance metrics
    is_correct BOOLEAN,
    performance_score NUMERIC(5, 4),

    -- Status
    status VARCHAR(20) DEFAULT 'PENDING',  -- PENDING/COMPLETED/FAILED
    created_at TIMESTAMP DEFAULT NOW(),
    evaluated_at TIMESTAMP
);
```

**ì¸ë±ìŠ¤**:
- `idx_price_tracking_ticker` - í‹°ì»¤ë³„ ì¡°íšŒ
- `idx_price_tracking_status` - ìƒíƒœë³„ ì¡°íšŒ
- `idx_price_tracking_created_at` - ì‹œê°„ìˆœ ì¡°íšŒ
- `idx_price_tracking_session_id` - ì„¸ì…˜ë³„ ì¡°íšŒ

### 2ï¸âƒ£ í† ë¡  ì‹œì  ê°€ê²© ì €ìž¥ ë¡œì§

**War Room í† ë¡  ì™„ë£Œ ì‹œ ìžë™ ì €ìž¥** ([war_room_router.py:264-330](backend/api/war_room_router.py#L264-L330)):

```python
async def save_initial_price_tracking(
    session_id: int,
    ticker: str,
    consensus_action: str,
    consensus_confidence: float,
    db: Any
) -> None:
    """Save initial price for 24-hour tracking"""

    # 1. Get current price from KIS API
    broker = KISBroker(...)
    price_data = broker.get_price(ticker, exchange="NASDAQ")
    current_price = price_data["current_price"]

    # 2. Save to price_tracking table
    INSERT INTO price_tracking (
        session_id, ticker, initial_price, initial_timestamp,
        consensus_action, consensus_confidence, status
    ) VALUES (
        ...
    )

    logger.info(f"ðŸ’¾ Price tracking saved: {ticker} @ ${current_price}")
```

**War Room í”Œë¡œìš°ì— í†µí•©**:
```python
# War Room debate ì™„ë£Œ í›„
session = AIDebateSession(...)
db.add(session)
db.commit()

# ðŸ†• Phase 25.1: Save initial price
await save_initial_price_tracking(
    session_id=session.id,
    ticker=ticker,
    consensus_action=pm_decision["consensus_action"],
    consensus_confidence=pm_decision["consensus_confidence"],
    db=db
)
```

### 3ï¸âƒ£ 24ì‹œê°„ í›„ í‰ê°€ ìŠ¤ì¼€ì¤„ëŸ¬

**ìŠ¤ì¼€ì¤„ëŸ¬** ([price_tracking_scheduler.py](backend/automation/price_tracking_scheduler.py)):

**ê¸°ëŠ¥**:
1. PENDING ìƒíƒœì´ê³  24ì‹œê°„ ì´ìƒ ê²½ê³¼í•œ ë ˆì½”ë“œ ì¡°íšŒ
2. KIS APIë¡œ í˜„ìž¬ ê°€ê²© ì¡°íšŒ
3. ìˆ˜ìµë¥  ê³„ì‚°
4. ì„±ê³¼ í‰ê°€ (ì •ë‹µ ì—¬ë¶€)
5. DB ì—…ë°ì´íŠ¸ (PENDING â†’ COMPLETED)

**ì„±ê³¼ í‰ê°€ ë¡œì§**:
```python
def evaluate_performance(consensus_action, return_pct, consensus_confidence):
    """
    Evaluate if consensus was correct

    Logic:
        - BUY: Correct if return_pct > 0
        - SELL: Correct if return_pct < 0
        - HOLD: Correct if abs(return_pct) < 2%

    Performance Score:
        - If correct: abs(return_pct) * consensus_confidence
        - If wrong: -abs(return_pct) * consensus_confidence
    """

    is_correct = False

    if consensus_action == "BUY":
        is_correct = return_pct > 0
    elif consensus_action == "SELL":
        is_correct = return_pct < 0
    elif consensus_action == "HOLD":
        is_correct = abs(return_pct) < 2.0  # Â±2% range

    if is_correct:
        performance_score = abs(return_pct) * consensus_confidence
    else:
        performance_score = -abs(return_pct) * consensus_confidence

    return is_correct, performance_score
```

**ì‹¤í–‰ ì˜ˆì‹œ**:
```bash
python backend/automation/price_tracking_scheduler.py
```

**ì¶œë ¥**:
```
================================================================================
ðŸ” Price Tracking Evaluation - 24h Later
================================================================================

ðŸ“Š Found 3 PENDING records to evaluate

â”Œâ”€ Evaluating #1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ Session: #11
â”‚ Ticker: AAPL
â”‚ Initial Price: $178.50
â”‚ Initial Time: 2025-12-23 12:48:56
â”‚ Consensus: BUY (72.9%)
â”‚
â”‚ ðŸ“ˆ Final Price: $180.20
â”‚ ðŸ“Š Price Change: +$1.70 (+0.95%)
â”‚
â”‚ ðŸŽ¯ Evaluation:
â”‚    Correct: âœ… YES
â”‚    Performance Score: +0.0069
â”‚
â”‚ âœ… Status: COMPLETED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

================================================================================
ðŸ“Š Evaluation Summary
================================================================================
âœ… Evaluated: 2
âŒ Failed: 1
ðŸ“Š Total: 3
================================================================================
```

---

## ðŸŽ¯ ì‹œìŠ¤í…œ í”Œë¡œìš°

```
1. War Room Debate
   - 7 agents vote
   - PM makes consensus
   - Constitutional validation
   â†“
2. Save Session to DB
   - ai_debate_sessions table
   â†“
3. ðŸ†• Save Initial Price (Phase 25.1)
   - Get current price from KIS API
   - Save to price_tracking table
   - Status: PENDING
   â†“
4. Wait 24 hours...
   â†“
5. Scheduler Runs (Cron Job)
   - Find PENDING records (24h+ old)
   - Get current price from KIS API
   - Calculate return_pct
   - Evaluate performance (is_correct)
   - Update status: PENDING â†’ COMPLETED
   â†“
6. Performance Analysis (Future)
   - Agent accuracy per action (BUY/SELL/HOLD)
   - Best/worst performing agents
   - Confidence vs actual performance
   - Self-learning feedback
```

---

## ðŸ“Š ë°ì´í„° ì˜ˆì‹œ

### price_tracking í…Œì´ë¸”

| id | session_id | ticker | initial_price | final_price | return_pct | consensus_action | is_correct | performance_score | status |
|----|------------|--------|---------------|-------------|------------|------------------|------------|-------------------|--------|
| 1 | 11 | AAPL | 178.50 | 180.20 | +0.95% | BUY | âœ… TRUE | +0.0069 | COMPLETED |
| 2 | 12 | TSLA | 252.80 | 248.50 | -1.70% | SELL | âœ… TRUE | +0.0087 | COMPLETED |
| 3 | 13 | NVDA | 495.20 | 492.30 | -0.59% | BUY | âŒ FALSE | -0.0041 | COMPLETED |
| 4 | 14 | GOOGL | 132.90 | 133.10 | +0.15% | HOLD | âœ… TRUE | +0.0009 | COMPLETED |

---

## ðŸ”§ ì£¼ìš” íŒŒì¼

### Backend

**Database**:
- [create_price_tracking_table.sql](backend/database/create_price_tracking_table.sql) - í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
- [create_price_tracking.py](backend/scripts/create_price_tracking.py) - í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸

**API**:
- [war_room_router.py](backend/api/war_room_router.py) - ì´ˆê¸° ê°€ê²© ì €ìž¥ ë¡œì§ í†µí•©

**Automation**:
- [price_tracking_scheduler.py](backend/automation/price_tracking_scheduler.py) - 24ì‹œê°„ í›„ í‰ê°€ ìŠ¤ì¼€ì¤„ëŸ¬

---

## âœ… Phase 25.1 ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°ì´í„°ë² ì´ìŠ¤
- [x] price_tracking í…Œì´ë¸” ì„¤ê³„
- [x] í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
- [x] ì¸ë±ìŠ¤ ì„¤ì •
- [x] ì œì•½ ì¡°ê±´ (UNIQUE, FOREIGN KEY)

### ê°€ê²© ì €ìž¥ ë¡œì§
- [x] War Room í† ë¡  ì™„ë£Œ ì‹œ ì´ˆê¸° ê°€ê²© ì €ìž¥
- [x] KIS API ê°€ê²© ì¡°íšŒ
- [x] price_tracking í…Œì´ë¸” INSERT
- [x] ì—ëŸ¬ í•¸ë“¤ë§ (ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ìŠ¤í‚µ)

### í‰ê°€ ìŠ¤ì¼€ì¤„ëŸ¬
- [x] PENDING ë ˆì½”ë“œ ì¡°íšŒ (24h+ ê²½ê³¼)
- [x] ìµœì¢… ê°€ê²© ì¡°íšŒ (KIS API)
- [x] ìˆ˜ìµë¥  ê³„ì‚°
- [x] ì„±ê³¼ í‰ê°€ ë¡œì§ (BUY/SELL/HOLD)
- [x] DB ì—…ë°ì´íŠ¸ (COMPLETED/FAILED)
- [x] ë¡œê¹… ë° ìš”ì•½ ì¶œë ¥

---

## ðŸš€ ì‹¤í–‰ ê°€ì´ë“œ

### 1. í…Œì´ë¸” ìƒì„±
```bash
cd ai-trading-system
python backend/scripts/create_price_tracking.py
```

### 2. War Room í† ë¡  (ê°€ê²© ìžë™ ì €ìž¥)
```bash
# í”„ë¡ íŠ¸ì—”ë“œì—ì„œ War Room í† ë¡  ì‹œìž‘
# ë˜ëŠ” API í˜¸ì¶œ
curl -X POST http://localhost:8001/api/war-room/debate \
  -H "Content-Type: application/json" \
  -d '{"ticker": "AAPL"}'
```

### 3. 24ì‹œê°„ í›„ í‰ê°€ (ìˆ˜ë™)
```bash
python backend/automation/price_tracking_scheduler.py
```

### 4. í¬ë¡  ìž‘ì—… ì„¤ì • (ìžë™)
```cron
# ë§¤ì‹œê°„ ì •ê°ì— ì‹¤í–‰
0 * * * * cd /path/to/ai-trading-system && python backend/automation/price_tracking_scheduler.py

# ë˜ëŠ” ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰
0 9 * * * cd /path/to/ai-trading-system && python backend/automation/price_tracking_scheduler.py
```

---

## ðŸ“Š ì„±ê³¼ ë¶„ì„ ì˜ˆì‹œ

### ì—ì´ì „íŠ¸ë³„ ì •í™•ë„ (ì˜ˆìƒ)

```sql
-- ì „ì²´ ì •í™•ë„
SELECT
    COUNT(*) as total_cases,
    SUM(CASE WHEN is_correct THEN 1 ELSE 0 END) as correct_cases,
    ROUND(SUM(CASE WHEN is_correct THEN 1 ELSE 0 END)::NUMERIC / COUNT(*) * 100, 2) as accuracy_pct
FROM price_tracking
WHERE status = 'COMPLETED';

-- ì•¡ì…˜ë³„ ì •í™•ë„
SELECT
    consensus_action,
    COUNT(*) as total,
    SUM(CASE WHEN is_correct THEN 1 ELSE 0 END) as correct,
    ROUND(SUM(CASE WHEN is_correct THEN 1 ELSE 0 END)::NUMERIC / COUNT(*) * 100, 2) as accuracy_pct,
    AVG(return_pct) as avg_return_pct
FROM price_tracking
WHERE status = 'COMPLETED'
GROUP BY consensus_action;

-- ì„±ê³¼ ìƒìœ„ 5ê°œ
SELECT
    ticker,
    consensus_action,
    return_pct,
    is_correct,
    performance_score
FROM price_tracking
WHERE status = 'COMPLETED'
ORDER BY performance_score DESC
LIMIT 5;
```

---

## ðŸ’¡ ë‹¤ìŒ ë‹¨ê³„ (Phase 25.2)

### 1. Performance API ì—”ë“œí¬ì¸íŠ¸
```python
# GET /api/performance/summary
{
    "total_predictions": 100,
    "correct_predictions": 67,
    "accuracy": 67.0,
    "avg_return": 1.2,
    "best_action": "BUY",  # BUY: 75%, SELL: 62%, HOLD: 65%
}

# GET /api/performance/by-agent
[
    {"agent": "trader", "accuracy": 72%, "avg_score": 0.0045},
    {"agent": "analyst", "accuracy": 68%, "avg_score": 0.0038},
    ...
]

# GET /api/performance/history
[
    {"date": "2025-12-23", "accuracy": 70%, "total": 10},
    ...
]
```

### 2. ì„±ê³¼ ëŒ€ì‹œë³´ë“œ UI
- ì „ì²´ ì •í™•ë„ ì¹´ë“œ
- ì•¡ì…˜ë³„ ì •í™•ë„ ì°¨íŠ¸ (BUY/SELL/HOLD)
- ì¼ë³„ ì •í™•ë„ íŠ¸ë Œë“œ
- ìµœê³ /ìµœì € ì„±ê³¼ ì„¸ì…˜
- ì—ì´ì „íŠ¸ë³„ ì •í™•ë„ (ë¯¸ëž˜)

### 3. ìžê¸°í•™ìŠµ í”¼ë“œë°± ë£¨í”„
- ì €ì„±ê³¼ ì—ì´ì „íŠ¸ ê²½ê³ 
- ê°€ì¤‘ì¹˜ ìžë™ ì¡°ì • (ì„±ê³¼ ê¸°ë°˜)
- ì‹ ë¢°ë„ vs ì‹¤ì œ ì„±ê³¼ ë¹„êµ
- í•™ìŠµ ë°ì´í„° ì¶•ì 

---

## ðŸ“ ì•Œë ¤ì§„ ì´ìŠˆ

### Issue #1: ì‹œìž¥ íœ´ë¬´ì¼ ì²˜ë¦¬
**ë¬¸ì œ**: ì£¼ë§/ê³µíœ´ì¼ì—ëŠ” 24ì‹œê°„ í›„ ê°€ê²© ì¡°íšŒ ë¶ˆê°€
**í•´ê²° í•„ìš”**: ë‹¤ìŒ ê±°ëž˜ì¼ ì¢…ê°€ë¡œ í‰ê°€

### Issue #2: ì—ì´ì „íŠ¸ë³„ ì„±ê³¼ ì¶”ì 
**í˜„ìž¬**: Consensusë§Œ ì¶”ì  (PM ìµœì¢… ê²°ì •)
**í•„ìš”**: ê°œë³„ ì—ì´ì „íŠ¸ íˆ¬í‘œë³„ ì„±ê³¼ ì¶”ì 

### Issue #3: í¬ë¡  ìž‘ì—… ë¯¸ì„¤ì •
**í˜„ìž¬**: ìˆ˜ë™ ì‹¤í–‰
**í•„ìš”**: ìžë™ í¬ë¡  ìž‘ì—… ì„¤ì •

---

**ìž‘ì„±**: 2025-12-23
**ìƒíƒœ**: âœ… Phase 25.1 ì™„ë£Œ
**ë‹¤ìŒ**: Performance API + ì„±ê³¼ ëŒ€ì‹œë³´ë“œ UI
