# ì‹¤ì œ ê±°ë˜ í…ŒìŠ¤íŠ¸ ê³„íš

**ë‚ ì§œ**: 2025-12-23
**í˜„ì¬ ì§„í–‰ë¥ **: 99.5%
**ê±°ë˜ í…ŒìŠ¤íŠ¸ ìƒíƒœ**: âŒ **ë¯¸ì‹¤ì‹œ**

---

## ğŸ¯ ì‹¤ì œ ê±°ë˜ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•œ ì´ìœ 

### í˜„ì¬ ìƒí™©
- âœ… **War Room ì‹œìŠ¤í…œ**: 8ê°œ ì—ì´ì „íŠ¸ ì™„ì„± (PM í¬í•¨)
- âœ… **ChipWarAgent**: ì¹© ì „ìŸ ë¶„ì„ ì™„ì„±
- âœ… **ìê¸°í•™ìŠµ ì„¤ê³„**: í• ë£¨ì‹œë„¤ì´ì…˜ ë°©ì§€ ì„¤ê³„ ì™„ë£Œ
- âœ… **KIS Broker**: í•œêµ­íˆ¬ìì¦ê¶Œ API í†µí•© ì™„ë£Œ
- âŒ **ì‹¤ê±°ë˜ ê²€ì¦**: í•œ ë²ˆë„ ì‹¤í–‰ ì•ˆ í•¨

### ë¬¸ì œì 
í˜„ì¬ëŠ” **ëª¨ë“  ê²ƒì´ ì´ë¡ **ì…ë‹ˆë‹¤:
- War Room í•©ì˜ â†’ PM ê²°ì • â†’ **ì—¬ê¸°ì„œ ë©ˆì¶¤**
- KIS Broker ì½”ë“œ ìˆì§€ë§Œ â†’ **ì‹¤ì œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„**
- ìê¸°í•™ìŠµë„ â†’ **ì‹œì¥ í”¼ë“œë°± ì—†ìœ¼ë©´ ì˜ë¯¸ ì—†ìŒ**

**ê²°ë¡ **: ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ ì—†ì´ëŠ” ìê¸°í•™ìŠµë„ ì‘ë™ ë¶ˆê°€!

---

## ğŸ“Š ì‹¤ì œ ê±°ë˜ í…ŒìŠ¤íŠ¸ ì‹œì  ì˜µì…˜

### **ì˜µì…˜ 1: ì§€ê¸ˆ ë‹¹ì¥** â­â­â­â­â­ (ìµœê³  ì¶”ì²œ)

**íƒ€ì´ë°**: Phase 25 (ìê¸°í•™ìŠµ) ì „ì— ë¨¼ì € í…ŒìŠ¤íŠ¸

**ì´ìœ **:
1. **ìê¸°í•™ìŠµì€ ì‹¤ê±°ë˜ í”¼ë“œë°±ì´ í•„ìˆ˜**
   - ì˜ˆì¸¡ â†’ ì‹¤ì œ ì‹œì¥ ë°˜ì‘ â†’ í•™ìŠµ ë£¨í”„
   - ì‹¤ê±°ë˜ ì—†ìœ¼ë©´ í•™ìŠµí•  ë°ì´í„° ì—†ìŒ

2. **War Roomì´ 99% ì™„ì„±ë¨**
   - 8ê°œ ì—ì´ì „íŠ¸ + PM ì‘ë™
   - í•©ì˜ ì•Œê³ ë¦¬ì¦˜ ì™„ì„±
   - ì‹¤í–‰ë§Œ í•˜ë©´ ë¨

3. **KIS ëª¨ì˜íˆ¬ì ê³„ì¢Œ ì‚¬ìš© ê°€ëŠ¥**
   - ì‹¤ì œ ëˆ ì•ˆ ì“°ê³  í…ŒìŠ¤íŠ¸
   - ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„°
   - ì§„ì§œ ì£¼ë¬¸ íë¦„ê³¼ ë™ì¼

**ì§„í–‰ ìˆœì„œ**:
```
ì˜¤ëŠ˜ (Day 1-2): Phase 25.0 - ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ (ëª¨ì˜íˆ¬ì)
  â†“
Day 3-9: Phase 25.1-25.4 - ìê¸°í•™ìŠµ êµ¬í˜„
  â†“
Day 10: ìê¸°í•™ìŠµ + ì‹¤ê±°ë˜ í†µí•© (í•™ìŠµ ë£¨í”„ ì™„ì„±)
```

**ì¥ì **:
- âœ… ì‹¤ê±°ë˜ ê²½í—˜ìœ¼ë¡œ ë²„ê·¸ ë°œê²¬ (ë¹¨ë¦¬ ê³ ì¹¨)
- âœ… ìê¸°í•™ìŠµ êµ¬í˜„ ì‹œ ì‹¤ì œ ë°ì´í„° ì‚¬ìš© ê°€ëŠ¥
- âœ… War Room ì„±ëŠ¥ ì‹¤ì „ ê²€ì¦
- âœ… PM í•©ì˜ ì•Œê³ ë¦¬ì¦˜ íŠœë‹ ê°€ëŠ¥

**ë‹¨ì **:
- âš ï¸ Phase 25 êµ¬í˜„ì´ 1-2ì¼ ëŠ¦ì–´ì§

---

### **ì˜µì…˜ 2: Phase 25 ì™„ë£Œ í›„** â­â­â­

**íƒ€ì´ë°**: ìê¸°í•™ìŠµ êµ¬í˜„ ì™„ë£Œ â†’ ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸

**ì´ìœ **:
- ìê¸°í•™ìŠµ ì½”ë“œê°€ ì¤€ë¹„ë˜ë©´ ì¦‰ì‹œ í•™ìŠµ ì‹œì‘
- í•œ ë²ˆì— í†µí•© í…ŒìŠ¤íŠ¸

**ì§„í–‰ ìˆœì„œ**:
```
Day 1-7: Phase 25 ìê¸°í•™ìŠµ êµ¬í˜„
  â†“
Day 8-9: Phase 25.0 ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ (ëª¨ì˜íˆ¬ì)
  â†“
Day 10: ìê¸°í•™ìŠµ + ì‹¤ê±°ë˜ í†µí•©
```

**ì¥ì **:
- âœ… ìê¸°í•™ìŠµ êµ¬í˜„ì— ì§‘ì¤‘ ê°€ëŠ¥
- âœ… ì™„ì„±ëœ ì‹œìŠ¤í…œì„ í•œ ë²ˆì— í…ŒìŠ¤íŠ¸

**ë‹¨ì **:
- âŒ ì‹¤ê±°ë˜ ë²„ê·¸ ë°œê²¬ì´ ëŠ¦ì–´ì§ (Phase 25 ëë‚œ í›„)
- âŒ ìê¸°í•™ìŠµ êµ¬í˜„ ì‹œ ê°€ìƒ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ (ë¹„í˜„ì‹¤ì )

---

### **ì˜µì…˜ 3: ì „ì²´ ì™„ë£Œ í›„** â­ (ë¹„ì¶”ì²œ)

**íƒ€ì´ë°**: Phase 25-26 ëª¨ë‘ ì™„ë£Œ â†’ ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸

**ì´ìœ **: ëª¨ë“  ê¸°ëŠ¥ ì™„ì„± í›„ ìµœì¢… ê²€ì¦

**ì¥ì **:
- âœ… ì•ˆì •ì ì¸ ì‹œìŠ¤í…œ ìƒíƒœ

**ë‹¨ì **:
- âŒ ë„ˆë¬´ ëŠ¦ìŒ (ì‹¤ê±°ë˜ ë²„ê·¸ ë°œê²¬ ì‹œ ëŒ€ê·œëª¨ ìˆ˜ì •)
- âŒ ìê¸°í•™ìŠµ ê²€ì¦ ë¶ˆê°€ (ì‹¤ì œ ë°ì´í„° ì—†ìŒ)
- âŒ War Room ì„±ëŠ¥ íŠœë‹ ê¸°íšŒ ìƒì‹¤

---

## ğŸ¯ **ì¶”ì²œ: ì˜µì…˜ 1 (ì§€ê¸ˆ ë‹¹ì¥)**

### Phase 25.0: ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ (ëª¨ì˜íˆ¬ì)

**ê¸°ê°„**: 1-2ì¼
**ìš°ì„ ìˆœìœ„**: â­â­â­â­â­
**ìœ„í—˜ë„**: ë‚®ìŒ (ëª¨ì˜íˆ¬ì ê³„ì¢Œ)

---

## ğŸ“‹ Phase 25.0 ìƒì„¸ ê³„íš

### **ëª©í‘œ**: War Room â†’ KIS ëª¨ì˜íˆ¬ì ì‹¤ê±°ë˜ ì—°ê²°

### **Step 1: ëª¨ì˜íˆ¬ì ê³„ì¢Œ ì¤€ë¹„** (30ë¶„)

**í•„ìš” ì •ë³´**:
- [ ] KIS ëª¨ì˜íˆ¬ì ì•±í‚¤ (APP_KEY)
- [ ] KIS ëª¨ì˜íˆ¬ì ì•±ì‹œí¬ë¦¿ (APP_SECRET)
- [ ] KIS ëª¨ì˜íˆ¬ì ê³„ì¢Œë²ˆí˜¸ (CANO-PRDT)

**ì„¤ì • íŒŒì¼**: `.env`
```bash
# KIS ëª¨ì˜íˆ¬ì ì„¤ì •
KIS_ACCOUNT_NO=12345678-01
KIS_APP_KEY=ëª¨ì˜íˆ¬ì_ì•±í‚¤
KIS_APP_SECRET=ëª¨ì˜íˆ¬ì_ì‹œí¬ë¦¿
KIS_IS_VIRTUAL=true  # ëª¨ì˜íˆ¬ì ëª¨ë“œ
```

---

### **Step 2: ì‹¤ê±°ë˜ íŒŒì´í”„ë¼ì¸ êµ¬í˜„** (2-3ì‹œê°„)

#### íŒŒì¼ 1: `backend/trading/war_room_executor.py` (ì‹ ê·œ)

**ê¸°ëŠ¥**: War Room ê²°ì •ì„ ì‹¤ì œ ì£¼ë¬¸ìœ¼ë¡œ ë³€í™˜

```python
"""
War Room Executor - War Room ê²°ì •ì„ ì‹¤ì œ ì£¼ë¬¸ìœ¼ë¡œ ì‹¤í–‰

ì›Œí¬í”Œë¡œìš°:
1. War Room í† ë¡  â†’ PM ê²°ì • (BUY/SELL/HOLD)
2. í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° (Constitution Rules)
3. KIS Brokerë¡œ ì£¼ë¬¸ ì „ì†¡
4. ì²´ê²° ê²°ê³¼ DB ì €ì¥
5. ìê¸°í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘
"""

import logging
from typing import Dict, Any, Optional
from datetime import datetime

from backend.brokers.kis_broker import KISBroker
from backend.automation.signal_to_order_converter import SignalToOrderConverter
from backend.database.models import AIDebateSession, TradeExecution
from backend.database.database import get_db

logger = logging.getLogger(__name__)


class WarRoomExecutor:
    """War Room ê²°ì •ì„ ì‹¤ì œ ì£¼ë¬¸ìœ¼ë¡œ ì‹¤í–‰"""

    def __init__(self, kis_broker: KISBroker):
        self.broker = kis_broker
        self.order_converter = SignalToOrderConverter()

    async def execute_war_room_decision(
        self,
        session: AIDebateSession,
        dry_run: bool = False
    ) -> Dict[str, Any]:
        """
        War Room ê²°ì •ì„ ì‹¤ì œ ì£¼ë¬¸ìœ¼ë¡œ ì‹¤í–‰

        Args:
            session: AI í† ë¡  ì„¸ì…˜ (PM ê²°ì • í¬í•¨)
            dry_run: True = ì‹¤ì œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„ (ì‹œë®¬ë ˆì´ì…˜ë§Œ)

        Returns:
            ì‹¤í–‰ ê²°ê³¼
        """
        ticker = session.ticker
        action = session.consensus_action  # BUY/SELL/HOLD
        confidence = session.consensus_confidence

        logger.info(
            f"ğŸ¯ War Room ê²°ì • ì‹¤í–‰: {ticker} {action} "
            f"({confidence:.0%} í™•ì‹ )"
        )

        # HOLDëŠ” ìŠ¤í‚µ
        if action == "HOLD":
            logger.info(f"â¸ï¸ {ticker} HOLD â†’ ì£¼ë¬¸ ì—†ìŒ")
            return {
                "status": "skipped",
                "reason": "HOLD decision",
                "ticker": ticker
            }

        # Step 1: í¬ì§€ì…˜ í¬ê¸° ê³„ì‚°
        position_size = self._calculate_position_size(
            ticker, action, confidence
        )

        if position_size == 0:
            logger.info(f"â¸ï¸ {ticker} í¬ì§€ì…˜ í¬ê¸° 0 â†’ ì£¼ë¬¸ ì—†ìŒ")
            return {
                "status": "skipped",
                "reason": "position_size_zero",
                "ticker": ticker
            }

        # Step 2: í˜„ì¬ ê°€ê²© ì¡°íšŒ
        current_price = await self._get_current_price(ticker)

        # Step 3: ì£¼ë¬¸ ìƒì„±
        order = {
            "ticker": ticker,
            "action": action,  # BUY/SELL
            "quantity": position_size,
            "price": current_price,
            "order_type": "market",  # ì‹œì¥ê°€
            "reason": f"War Room consensus {confidence:.0%}",
            "session_id": session.id
        }

        logger.info(
            f"ğŸ“ ì£¼ë¬¸ ìƒì„±: {action} {position_size}ì£¼ @ ${current_price:.2f}"
        )

        # Step 4: ì£¼ë¬¸ ì‹¤í–‰ (dry_run ì²´í¬)
        if dry_run:
            logger.info(f"ğŸ§ª DRY RUN ëª¨ë“œ â†’ ì‹¤ì œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„")
            execution_result = {
                "status": "dry_run",
                "order": order,
                "execution_price": current_price,
                "executed_quantity": position_size,
                "message": "Dry run - no real order sent"
            }
        else:
            # ì‹¤ì œ ì£¼ë¬¸ ì „ì†¡
            execution_result = await self._send_order_to_broker(order)

        # Step 5: DB ì €ì¥ (ì²´ê²° ê¸°ë¡)
        await self._save_execution_to_db(order, execution_result, session)

        logger.info(
            f"âœ… {ticker} ì£¼ë¬¸ ì™„ë£Œ: {execution_result['status']}"
        )

        return execution_result

    def _calculate_position_size(
        self,
        ticker: str,
        action: str,
        confidence: float
    ) -> int:
        """
        í¬ì§€ì…˜ í¬ê¸° ê³„ì‚° (Constitution Rules)

        ê·œì¹™:
        - ì‹ ë¢°ë„ > 80%: 2% ìë³¸
        - ì‹ ë¢°ë„ 60-80%: 1% ìë³¸
        - ì‹ ë¢°ë„ < 60%: 0.5% ìë³¸
        """
        # ê³„ì¢Œ ì”ê³  ì¡°íšŒ
        account_balance = self.broker.get_account_balance()
        total_capital = account_balance["total_value"]

        # ì‹ ë¢°ë„ ê¸°ë°˜ ìë³¸ ë°°ë¶„
        if confidence >= 0.80:
            capital_ratio = 0.02  # 2%
        elif confidence >= 0.60:
            capital_ratio = 0.01  # 1%
        else:
            capital_ratio = 0.005  # 0.5%

        allocated_capital = total_capital * capital_ratio

        # í˜„ì¬ ê°€ê²©ìœ¼ë¡œ ì£¼ì‹ ìˆ˜ ê³„ì‚°
        current_price = self.broker.get_current_price(ticker)
        position_size = int(allocated_capital / current_price)

        logger.info(
            f"ğŸ’° í¬ì§€ì…˜ í¬ê¸°: {position_size}ì£¼ "
            f"(ìë³¸ {capital_ratio:.1%} = ${allocated_capital:,.0f})"
        )

        return position_size

    async def _get_current_price(self, ticker: str) -> float:
        """í˜„ì¬ ê°€ê²© ì¡°íšŒ"""
        price = self.broker.get_current_price(ticker)
        logger.info(f"ğŸ’µ {ticker} í˜„ì¬ê°€: ${price:.2f}")
        return price

    async def _send_order_to_broker(self, order: Dict) -> Dict:
        """KIS Brokerë¡œ ì‹¤ì œ ì£¼ë¬¸ ì „ì†¡"""
        try:
            if order["action"] == "BUY":
                result = self.broker.buy_market_order(
                    ticker=order["ticker"],
                    quantity=order["quantity"]
                )
            else:  # SELL
                result = self.broker.sell_market_order(
                    ticker=order["ticker"],
                    quantity=order["quantity"]
                )

            logger.info(f"ğŸ“¤ KIS ì£¼ë¬¸ ì „ì†¡ ì„±ê³µ: {result}")
            return result

        except Exception as e:
            logger.error(f"âŒ KIS ì£¼ë¬¸ ì‹¤íŒ¨: {e}")
            return {
                "status": "failed",
                "error": str(e),
                "order": order
            }

    async def _save_execution_to_db(
        self,
        order: Dict,
        execution_result: Dict,
        session: AIDebateSession
    ):
        """ì²´ê²° ê²°ê³¼ DB ì €ì¥ (ìê¸°í•™ìŠµ ë°ì´í„°)"""
        db = next(get_db())

        trade_execution = TradeExecution(
            session_id=session.id,
            ticker=order["ticker"],
            action=order["action"],
            quantity=execution_result.get("executed_quantity", 0),
            price=execution_result.get("execution_price", 0),
            status=execution_result["status"],
            executed_at=datetime.now(),
            war_room_confidence=session.consensus_confidence,
            # ìê¸°í•™ìŠµìš© í•„ë“œ
            prediction_action=order["action"],
            prediction_confidence=session.consensus_confidence,
            actual_outcome=None,  # 24ì‹œê°„ í›„ ì—…ë°ì´íŠ¸
            learning_accuracy=None  # 24ì‹œê°„ í›„ ê³„ì‚°
        )

        db.add(trade_execution)
        db.commit()

        logger.info(f"ğŸ’¾ ì²´ê²° ê¸°ë¡ ì €ì¥ ì™„ë£Œ (ID: {trade_execution.id})")
```

---

#### íŒŒì¼ 2: `backend/database/models.py` (ìˆ˜ì •)

**ì¶”ê°€ í…Œì´ë¸”**: ì²´ê²° ê¸°ë¡ (ìê¸°í•™ìŠµìš©)

```python
class TradeExecution(Base):
    """ì‹¤ì œ ê±°ë˜ ì²´ê²° ê¸°ë¡ (ìê¸°í•™ìŠµ ë°ì´í„°)"""
    __tablename__ = "trade_executions"

    id = Column(Integer, primary_key=True, index=True)
    session_id = Column(Integer, ForeignKey("ai_debate_sessions.id"))

    # ì£¼ë¬¸ ì •ë³´
    ticker = Column(String(10), nullable=False)
    action = Column(String(10), nullable=False)  # BUY/SELL
    quantity = Column(Integer, nullable=False)
    price = Column(Float, nullable=False)
    status = Column(String(20), nullable=False)  # executed/failed/dry_run
    executed_at = Column(DateTime, default=datetime.now)

    # War Room ê²°ì •
    war_room_confidence = Column(Float)  # PM ì‹ ë¢°ë„

    # ìê¸°í•™ìŠµìš© í•„ë“œ
    prediction_action = Column(String(10))  # ì˜ˆì¸¡í•œ ì•¡ì…˜
    prediction_confidence = Column(Float)   # ì˜ˆì¸¡ ì‹ ë¢°ë„
    actual_outcome = Column(String(10))     # ì‹¤ì œ ê²°ê³¼ (24h í›„ UPDATE)
    actual_return = Column(Float)           # ì‹¤ì œ ìˆ˜ìµë¥  (24h í›„)
    learning_accuracy = Column(Float)       # ì •í™•ë„ (1.0 = ì™„ë²½)

    # ê´€ê³„
    session = relationship("AIDebateSession", back_populates="executions")

# AIDebateSessionì— ì¶”ê°€
AIDebateSession.executions = relationship(
    "TradeExecution",
    back_populates="session"
)
```

---

#### íŒŒì¼ 3: `backend/api/war_room_router.py` (ìˆ˜ì •)

**ì¶”ê°€ ì—”ë“œí¬ì¸íŠ¸**: ì‹¤ê±°ë˜ ì‹¤í–‰

```python
from backend.trading.war_room_executor import WarRoomExecutor

# ì „ì—­ ë³€ìˆ˜
kis_broker = None
war_room_executor = None

@router.on_event("startup")
async def initialize_kis_broker():
    """KIS Broker ì´ˆê¸°í™” (ëª¨ì˜íˆ¬ì)"""
    global kis_broker, war_room_executor

    account_no = os.getenv("KIS_ACCOUNT_NO")
    is_virtual = os.getenv("KIS_IS_VIRTUAL", "true").lower() == "true"

    if account_no:
        kis_broker = KISBroker(
            account_no=account_no,
            is_virtual=is_virtual
        )
        war_room_executor = WarRoomExecutor(kis_broker)
        logger.info("âœ… KIS Broker ì´ˆê¸°í™” ì™„ë£Œ")
    else:
        logger.warning("âš ï¸ KIS ê³„ì¢Œ ì •ë³´ ì—†ìŒ - ì‹¤ê±°ë˜ ë¶ˆê°€")


@router.post("/debate-and-execute")
async def debate_and_execute_trade(
    request: DebateRequest,
    dry_run: bool = True,  # ê¸°ë³¸ê°’: ì‹œë®¬ë ˆì´ì…˜
    db: Session = Depends(get_db)
):
    """
    War Room í† ë¡  â†’ ì‹¤ê±°ë˜ ì‹¤í–‰

    Args:
        ticker: ì¢…ëª© ì½”ë“œ
        dry_run: True = ì‹œë®¬ë ˆì´ì…˜ë§Œ, False = ì‹¤ì œ ì£¼ë¬¸

    Returns:
        í† ë¡  ê²°ê³¼ + ì²´ê²° ê²°ê³¼
    """
    ticker = request.ticker.upper()

    # Step 1: War Room í† ë¡ 
    logger.info(f"ğŸ­ War Room í† ë¡  ì‹œì‘: {ticker}")
    debate_result = await run_war_room_debate(ticker, db)

    # Step 2: ì‹¤ê±°ë˜ ì‹¤í–‰
    if war_room_executor:
        logger.info(f"ğŸ¯ ì‹¤ê±°ë˜ ì‹¤í–‰ {'(DRY RUN)' if dry_run else '(REAL)'}")

        session = debate_result["session"]
        execution_result = await war_room_executor.execute_war_room_decision(
            session=session,
            dry_run=dry_run
        )

        debate_result["execution"] = execution_result
    else:
        logger.warning("âš ï¸ KIS Broker ë¯¸ì´ˆê¸°í™” - ì‹¤ê±°ë˜ ë¶ˆê°€")
        debate_result["execution"] = {
            "status": "unavailable",
            "reason": "KIS Broker not initialized"
        }

    return debate_result
```

---

### **Step 3: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤** (2-3ì‹œê°„)

#### í…ŒìŠ¤íŠ¸ 1: DRY RUN (ì‹œë®¬ë ˆì´ì…˜)

**íŒŒì¼**: `backend/tests/test_war_room_executor_dry_run.py`

```python
"""War Room Executor í…ŒìŠ¤íŠ¸ - DRY RUN ëª¨ë“œ"""

import pytest
from backend.trading.war_room_executor import WarRoomExecutor
from backend.api.war_room_router import debate_and_execute_trade

@pytest.mark.asyncio
async def test_dry_run_mode():
    """DRY RUN ëª¨ë“œ í…ŒìŠ¤íŠ¸ (ì‹¤ì œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„)"""

    # War Room í† ë¡  + ì‹¤í–‰ (DRY RUN)
    result = await debate_and_execute_trade(
        ticker="AAPL",
        dry_run=True  # ì‹œë®¬ë ˆì´ì…˜ë§Œ
    )

    # ê²€ì¦
    assert result["consensus_action"] in ["BUY", "SELL", "HOLD"]
    assert "execution" in result
    assert result["execution"]["status"] == "dry_run"

    print(f"âœ… DRY RUN ì„±ê³µ: {result['ticker']} {result['consensus_action']}")
    print(f"   í¬ì§€ì…˜: {result['execution']['order']['quantity']}ì£¼")
    print(f"   ê°€ê²©: ${result['execution']['execution_price']:.2f}")
```

**ì‹¤í–‰**:
```bash
pytest backend/tests/test_war_room_executor_dry_run.py -v
```

**ì˜ˆìƒ ê²°ê³¼**:
```
ğŸ­ War Room í† ë¡ : AAPL
  NewsAgent: BUY (70%)
  TraderAgent: BUY (80%)
  ...
  PM ê²°ì •: BUY (76%)

ğŸ¯ ì‹¤ê±°ë˜ ì‹¤í–‰ (DRY RUN)
  ğŸ’° í¬ì§€ì…˜ í¬ê¸°: 25ì£¼ (ìë³¸ 2.0% = $5,000)
  ğŸ’µ AAPL í˜„ì¬ê°€: $195.50
  ğŸ“ ì£¼ë¬¸ ìƒì„±: BUY 25ì£¼ @ $195.50
  ğŸ§ª DRY RUN ëª¨ë“œ â†’ ì‹¤ì œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„
  ğŸ’¾ ì²´ê²° ê¸°ë¡ ì €ì¥ ì™„ë£Œ

âœ… PASS
```

---

#### í…ŒìŠ¤íŠ¸ 2: REAL MODE (ì‹¤ì œ ì£¼ë¬¸ - ëª¨ì˜íˆ¬ì)

**íŒŒì¼**: `backend/tests/test_war_room_executor_real.py`

```python
"""War Room Executor í…ŒìŠ¤íŠ¸ - REAL ëª¨ë“œ (ëª¨ì˜íˆ¬ì)"""

import pytest
from backend.trading.war_room_executor import WarRoomExecutor

@pytest.mark.asyncio
async def test_real_mode_virtual_account():
    """REAL ëª¨ë“œ í…ŒìŠ¤íŠ¸ (KIS ëª¨ì˜íˆ¬ì ê³„ì¢Œ)"""

    # ì£¼ì˜: KIS ëª¨ì˜íˆ¬ì ê³„ì¢Œ í•„ìš”
    result = await debate_and_execute_trade(
        ticker="AAPL",
        dry_run=False  # ì‹¤ì œ ì£¼ë¬¸ (ëª¨ì˜íˆ¬ì)
    )

    # ê²€ì¦
    assert result["execution"]["status"] in ["executed", "failed"]

    if result["execution"]["status"] == "executed":
        print(f"âœ… ì‹¤ì œ ì£¼ë¬¸ ì„±ê³µ!")
        print(f"   ì¢…ëª©: {result['ticker']}")
        print(f"   ì•¡ì…˜: {result['consensus_action']}")
        print(f"   ì²´ê²°: {result['execution']['executed_quantity']}ì£¼")
        print(f"   ê°€ê²©: ${result['execution']['execution_price']:.2f}")
    else:
        print(f"âŒ ì£¼ë¬¸ ì‹¤íŒ¨: {result['execution']['error']}")
```

**ì‹¤í–‰** (ëª¨ì˜íˆ¬ì ê³„ì¢Œ ì„¤ì • í•„ìˆ˜):
```bash
# .env íŒŒì¼ í™•ì¸
echo $KIS_ACCOUNT_NO
echo $KIS_IS_VIRTUAL  # true í™•ì¸

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
pytest backend/tests/test_war_room_executor_real.py -v -s
```

**ì˜ˆìƒ ê²°ê³¼** (ì„±ê³µ ì‹œ):
```
ğŸ­ War Room í† ë¡ : AAPL
  PM ê²°ì •: BUY (76%)

ğŸ¯ ì‹¤ê±°ë˜ ì‹¤í–‰ (REAL)
  ğŸ’° í¬ì§€ì…˜ í¬ê¸°: 25ì£¼
  ğŸ“¤ KIS ì£¼ë¬¸ ì „ì†¡...
  âœ… KIS ì£¼ë¬¸ ì²´ê²° ì™„ë£Œ
     ì£¼ë¬¸ë²ˆí˜¸: VT20241223001
     ì²´ê²°ê°€: $195.55
     ì²´ê²°ëŸ‰: 25ì£¼

âœ… PASS - ì‹¤ì œ ì£¼ë¬¸ ì„±ê³µ (ëª¨ì˜íˆ¬ì ê³„ì¢Œ)
```

---

### **Step 4: ìê¸°í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘** (1ì‹œê°„)

#### 24ì‹œê°„ í›„ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼**: `backend/scripts/update_trade_outcomes.py`

```python
"""
ê±°ë˜ ê²°ê³¼ ì—…ë°ì´íŠ¸ - 24ì‹œê°„ í›„ ì‹¤ì œ ìˆ˜ìµë¥  ê³„ì‚°

Cron Job:
0 9 * * * python backend/scripts/update_trade_outcomes.py
"""

import logging
from datetime import datetime, timedelta
from backend.database.database import get_db
from backend.database.models import TradeExecution
from backend.brokers.kis_broker import KISBroker

logger = logging.getLogger(__name__)


async def update_trade_outcomes():
    """24ì‹œê°„ ì§€ë‚œ ê±°ë˜ì˜ ì‹¤ì œ ê²°ê³¼ ì—…ë°ì´íŠ¸"""

    db = next(get_db())

    # 24ì‹œê°„ ì „ ê±°ë˜ ì¡°íšŒ (actual_outcomeì´ NULLì¸ ê²ƒë§Œ)
    yesterday = datetime.now() - timedelta(hours=24)

    pending_trades = db.query(TradeExecution).filter(
        TradeExecution.executed_at <= yesterday,
        TradeExecution.actual_outcome == None
    ).all()

    logger.info(f"ğŸ“Š ì—…ë°ì´íŠ¸ ëŒ€ê¸° ê±°ë˜: {len(pending_trades)}ê±´")

    broker = KISBroker(account_no=os.getenv("KIS_ACCOUNT_NO"), is_virtual=True)

    for trade in pending_trades:
        # 24ì‹œê°„ í›„ ê°€ê²© ì¡°íšŒ
        current_price = broker.get_current_price(trade.ticker)
        entry_price = trade.price

        # ìˆ˜ìµë¥  ê³„ì‚°
        if trade.action == "BUY":
            actual_return = (current_price - entry_price) / entry_price
        else:  # SELL
            actual_return = (entry_price - current_price) / entry_price

        # ì˜ˆì¸¡ vs ì‹¤ì œ ë¹„êµ
        if actual_return > 0:
            actual_outcome = "BUY"  # ìƒìŠ¹
        elif actual_return < 0:
            actual_outcome = "SELL"  # í•˜ë½
        else:
            actual_outcome = "HOLD"  # íš¡ë³´

        # ì •í™•ë„ ê³„ì‚°
        if trade.prediction_action == actual_outcome:
            learning_accuracy = 1.0  # ì™„ë²½
        elif trade.prediction_action == "HOLD":
            learning_accuracy = 0.5  # ì¤‘ë¦½
        else:
            learning_accuracy = 0.0  # í‹€ë¦¼

        # DB ì—…ë°ì´íŠ¸
        trade.actual_outcome = actual_outcome
        trade.actual_return = actual_return
        trade.learning_accuracy = learning_accuracy

        logger.info(
            f"âœ… {trade.ticker} ì—…ë°ì´íŠ¸: "
            f"ì˜ˆì¸¡={trade.prediction_action}, "
            f"ì‹¤ì œ={actual_outcome}, "
            f"ìˆ˜ìµë¥ ={actual_return:.2%}, "
            f"ì •í™•ë„={learning_accuracy:.0%}"
        )

    db.commit()
    logger.info(f"ğŸ’¾ {len(pending_trades)}ê±´ ì—…ë°ì´íŠ¸ ì™„ë£Œ")


if __name__ == "__main__":
    import asyncio
    asyncio.run(update_trade_outcomes())
```

**Cron ì„¤ì •** (Linux/Mac):
```bash
# ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì‹¤í–‰
0 9 * * * cd /path/to/ai-trading-system && python backend/scripts/update_trade_outcomes.py
```

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì˜ˆìƒ

### Day 1: ì²« ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸

**ì˜¤ì „**:
- KIS ëª¨ì˜íˆ¬ì ê³„ì¢Œ ì„¤ì •
- War Room Executor êµ¬í˜„
- DRY RUN í…ŒìŠ¤íŠ¸ (5ì¢…ëª©)

**ì˜¤í›„**:
- REAL MODE í…ŒìŠ¤íŠ¸ (ëª¨ì˜íˆ¬ì)
- ì²« ì‹¤ì œ ì£¼ë¬¸ (AAPL, NVDA, GOOGL)

**ì˜ˆìƒ ê²°ê³¼**:
```
ì¢…ëª©: AAPL
War Room ê²°ì •: BUY (76%)
ì£¼ë¬¸: BUY 25ì£¼ @ $195.50
ì²´ê²°: âœ… ì„±ê³µ
```

### Day 2: 24ì‹œê°„ í›„ ê²°ê³¼ í™•ì¸

**ì˜¤ì „ 9ì‹œ**:
- ìë™ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- ì–´ì œ ì£¼ë¬¸ ê²°ê³¼ ì—…ë°ì´íŠ¸

**ì˜ˆìƒ ê²°ê³¼**:
```
AAPL:
  ì˜ˆì¸¡: BUY (ìƒìŠ¹ ì˜ˆìƒ)
  ì‹¤ì œ: BUY (ì‹¤ì œë¡œ +2.1% ìƒìŠ¹)
  ì •í™•ë„: 100% âœ…

NVDA:
  ì˜ˆì¸¡: BUY (ìƒìŠ¹ ì˜ˆìƒ)
  ì‹¤ì œ: SELL (ì‹¤ì œë¡œ -1.5% í•˜ë½)
  ì •í™•ë„: 0% âŒ

GOOGL:
  ì˜ˆì¸¡: HOLD (íš¡ë³´ ì˜ˆìƒ)
  ì‹¤ì œ: BUY (ì‹¤ì œë¡œ +0.5% ìƒìŠ¹)
  ì •í™•ë„: 50%
```

**ì²« ë‚  í‰ê·  ì •í™•ë„**: 50-60% ì˜ˆìƒ (ìê¸°í•™ìŠµ ì „)

---

## ğŸ¯ ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… ì‚¬ì „ ì¤€ë¹„ (30ë¶„)
- [ ] KIS ëª¨ì˜íˆ¬ì ê³„ì¢Œ ë°œê¸‰
- [ ] APP_KEY, APP_SECRET ë°œê¸‰
- [ ] .env íŒŒì¼ ì„¤ì •
- [ ] ëª¨ì˜íˆ¬ì ì”ê³  í™•ì¸ (ìµœì†Œ $10,000 ê¶Œì¥)

### ğŸ”¨ êµ¬í˜„ (2-3ì‹œê°„)
- [ ] WarRoomExecutor êµ¬í˜„
- [ ] TradeExecution í…Œì´ë¸” ì¶”ê°€
- [ ] DB ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] /debate-and-execute API ì¶”ê°€

### ğŸ§ª í…ŒìŠ¤íŠ¸ (2-3ì‹œê°„)
- [ ] DRY RUN í…ŒìŠ¤íŠ¸ (5ì¢…ëª©)
- [ ] REAL MODE í…ŒìŠ¤íŠ¸ (3ì¢…ëª©)
- [ ] ì²´ê²° í™•ì¸ (KIS ì•±)
- [ ] DB ì €ì¥ í™•ì¸

### ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ (1ì‹œê°„)
- [ ] update_trade_outcomes.py êµ¬í˜„
- [ ] Cron Job ì„¤ì •
- [ ] 24ì‹œê°„ í›„ ê²°ê³¼ í™•ì¸

### ğŸ“ˆ ë¶„ì„ (1ì‹œê°„)
- [ ] ì²« ë‚  ì •í™•ë„ ê³„ì‚°
- [ ] ì—ì´ì „íŠ¸ë³„ ì„±ëŠ¥ ë¶„ì„
- [ ] PM í•©ì˜ ì•Œê³ ë¦¬ì¦˜ ê²€ì¦

---

## ğŸ’¡ ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ í›„ ì–»ëŠ” ê²ƒ

### 1. **ë²„ê·¸ ë°œê²¬**
- KIS API ì—°ë™ ë¬¸ì œ
- ì£¼ë¬¸ í¬ê¸° ê³„ì‚° ì˜¤ë¥˜
- ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨

### 2. **War Room ê²€ì¦**
- 8ê°œ ì—ì´ì „íŠ¸ ì‹¤ì „ ì„±ëŠ¥
- PM í•©ì˜ ì•Œê³ ë¦¬ì¦˜ ì •í™•ë„
- ì‹ ë¢°ë„ë³„ ì„±ëŠ¥ ì°¨ì´

### 3. **ìê¸°í•™ìŠµ ë°ì´í„°**
- ì‹¤ì œ ì˜ˆì¸¡ vs ê²°ê³¼
- ì—ì´ì „íŠ¸ë³„ ì •í™•ë„
- 24ì‹œê°„ ìˆ˜ìµë¥  ë¶„í¬

### 4. **ì‹œìŠ¤í…œ íŠœë‹**
- í¬ì§€ì…˜ í¬ê¸° ìµœì í™”
- ì‹ ë¢°ë„ ì„ê³„ê°’ ì¡°ì •
- ì—ì´ì „íŠ¸ ê°€ì¤‘ì¹˜ ì¬ì¡°ì •

---

## ğŸš€ ìµœì¢… ê¶Œì¥ ì¼ì •

### **ì˜¤ëŠ˜ ~ ë‚´ì¼ (Day 1-2)**
- Phase 25.0: ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ (ëª¨ì˜íˆ¬ì)
- 3ì¢…ëª© ì‹¤ì œ ì£¼ë¬¸
- ë²„ê·¸ ìˆ˜ì •

### **Day 3 (24ì‹œê°„ í›„)**
- ê±°ë˜ ê²°ê³¼ í™•ì¸
- ì •í™•ë„ ë¶„ì„
- í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘

### **Day 4-10**
- Phase 25.1-25.4: ìê¸°í•™ìŠµ êµ¬í˜„
- ì‹¤ê±°ë˜ ë°ì´í„°ë¡œ í•™ìŠµ ì‹œì‘

### **Day 11+**
- ìê¸°í•™ìŠµ + ì‹¤ê±°ë˜ ì™„ì „ í†µí•©
- ë§¤ì¼ í•™ìŠµí•˜ê³  ê°œì„ í•˜ëŠ” ì‹œìŠ¤í…œ ì™„ì„±

---

## âœ… ê²°ë¡ 

**ì¶”ì²œ**: **ì§€ê¸ˆ ë‹¹ì¥ ì‹¤ê±°ë˜ í…ŒìŠ¤íŠ¸ (ëª¨ì˜íˆ¬ì)** â­â­â­â­â­

**ì´ìœ **:
1. War Room 99% ì™„ì„± â†’ ì‹¤í–‰ë§Œ í•˜ë©´ ë¨
2. ìê¸°í•™ìŠµì€ ì‹¤ê±°ë˜ ë°ì´í„° í•„ìˆ˜
3. ë²„ê·¸ ì¡°ê¸° ë°œê²¬ â†’ ë¹¨ë¦¬ ê³ ì¹¨
4. KIS ëª¨ì˜íˆ¬ì = ìœ„í—˜ ì œë¡œ

**ì˜ˆìƒ ì†Œìš”**: 1-2ì¼
**ìœ„í—˜ë„**: ë‚®ìŒ (ëª¨ì˜íˆ¬ì)
**íš¨ê³¼**: ìê¸°í•™ìŠµ êµ¬í˜„ ì‹œ ì‹¤ì œ ë°ì´í„° í™•ë³´

ğŸ¯ **ì˜¤ëŠ˜ ë°”ë¡œ ì‹œì‘í•˜ëŠ” ê²ƒì„ ê°•ë ¥ ì¶”ì²œí•©ë‹ˆë‹¤!**
